<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GenZ Smart — Community</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* ---------------- YouTube Community - Light-first theme ---------------- */
  :root{
    --bg:#ffffff; --panel:#ffffff; --muted:#6b7280; --text:#0b1220;
    --divider: rgba(11,18,32,0.06); --card-shadow: 0 8px 24px rgba(2,6,23,0.06);
    --youtube-red:#ff2b2b; --accent:#1d9bf0;
    --radius:12px;
    --gradient-start: #ff6b6b; --gradient-end: #ff2b2b;
  }
  .dark{
    --bg:#0b1220; --panel:#0f1724; --muted:#98aac6; --text:#e6f0ff;
    --divider: rgba(255,255,255,0.04); --card-shadow:0 8px 24px rgba(2,6,23,0.6);
    --youtube-red:#ff3838; --accent:#1d9bf0;
    --gradient-start: #ff3838; --gradient-end: #ff6b6b;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:linear-gradient(180deg,var(--bg),#f6f7fb);
    color:var(--text);
    line-height: 1.6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Typography improvements */
  h1, h2, h3, h4 {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 0.5rem;
  }
  
  p {
    margin-bottom: 1rem;
  }

  /* app container */
  .wrap{max-width:920px;margin:0 auto;padding:14px;min-height:100vh}

  /* header (YouTube-like) */
  header{position:sticky;top:0;z-index:140;display:flex;align-items:center;justify-content:space-between;padding:12px;background:transparent; backdrop-filter: blur(8px); }
  .brand{display:flex;align-items:center;gap:12px}
  .ch-avatar{width:48px;height:48px;border-radius:8px;background:var(--youtube-red);display:grid;place-items:center;color:#fff;font-weight:800;font-family:Poppins}
  .site-title{font-weight:800;font-family:Poppins; font-size: 1.4rem;}
  .site-subtitle{font-size:12px;color:var(--muted); font-weight: 500;}
  .header-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{background:transparent;border:0;color:var(--text);font-size:18px;padding:8px;border-radius:10px;cursor:pointer; transition: all 0.2s ease;}
  .icon-btn:hover {background: rgba(0,0,0,0.05);}

  /* top nav tabs */
  .tabs{display:flex;gap:8px;align-items:center;padding:12px 0;border-bottom:1px solid var(--divider)}
  .tab{padding:8px 18px;border-radius:999px;background:transparent;border:0;color:var(--muted);font-weight:600;cursor:pointer; transition: all 0.2s ease;}
  .tab.active{background:var(--youtube-red);color:#fff;}

  /* hero banner small */
  .hero{margin:14px 0}
  .hero-card{padding:20px;border-radius:16px;background:linear-gradient(90deg,var(--gradient-start),var(--gradient-end));color:#fff;box-shadow:var(--card-shadow)}
  .hero-title{font-family:'Poppins';font-weight:800;font-size:22px; margin-bottom: 6px;}
  .hero-quote{opacity: 0.9; margin-top:6px; font-style: italic;}

  /* layout: feed column */
  .content{display:flex;flex-direction:column;gap:12px;margin-top:12px}

  /* composer / create post */
  .composer{display:none;gap:12px;padding:20px;border-radius:16px;background:var(--panel);border:1px solid var(--divider);box-shadow:var(--card-shadow)}
  .comp-row{display:flex;gap:12px}
  .comp-avatar{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:var(--youtube-red);color:#fff;font-weight:800}
  .comp-box{flex:1}
  .comp-title{display:flex;gap:8px;align-items:center}
  .comp-title input{flex:1;padding:12px;border-radius:8px;border:1px solid var(--divider);background:transparent;color:var(--text); font-family: 'Inter', sans-serif;}
  .comp-text{width:100%;min-height:100px;padding:12px;margin-top:8px;border-radius:8px;border:1px solid var(--divider);background:transparent;color:var(--text); font-family: 'Inter', sans-serif; resize: vertical;}
  .comp-meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .btn-red{background:var(--youtube-red);color:#fff;padding:10px 20px;border-radius:999px;border:0;font-weight:600;cursor:pointer; transition: all 0.2s ease;}
  .btn-red:hover {opacity: 0.9; transform: translateY(-2px);}
  .btn-ghost {background: transparent; border: 1px solid var(--divider); color: var(--text); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;}
  .small-input{padding:10px;border-radius:8px;border:1px solid var(--divider);background:transparent;color:var(--text); font-family: 'Inter', sans-serif;}

  /* post card (like community post) */
  .post-card{background:var(--panel);border:1px solid var(--divider);padding:20px;border-radius:16px;box-shadow:var(--card-shadow); transition: all 0.2s ease;}
  .post-card:hover {transform: translateY(-4px); box-shadow: 0 12px 28px rgba(2,6,23,0.1);}
  .post-head{display:flex;gap:12px;align-items:center}
  .post-avatar{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#ddd;color:#111;font-weight:800}
  .post-meta{display:flex;flex-direction:column}
  .post-author{font-weight:700; font-family: 'Poppins', sans-serif;}
  .post-time{color:var(--muted);font-size:13px;margin-top:2px}
  .post-title{font-weight:800;margin-top:12px; font-size: 1.2rem; font-family: 'Poppins', sans-serif; cursor: pointer;}
  .post-body{margin-top:12px;line-height:1.6;color:var(--text)}
  .post-image{margin-top:14px;width:100%;border-radius:12px;max-height:360px;object-fit:cover}
  .post-actions{display:flex;gap:8px;margin-top:14px;color:var(--muted);font-weight:700}

  /* single post view */
  .post-view{display:none;padding:20px;border-radius:16px;background:var(--panel);border:1px solid var(--divider);box-shadow:var(--card-shadow)}

  /* about page */
  .about-banner{height:160px;border-radius:16px;background:linear-gradient(90deg,var(--gradient-start),var(--gradient-end));overflow:hidden; position: relative;}
  .about-banner::after {
    content: '';
    position: absolute;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' width='100' height='100' opacity='0.1'%3E%3Ccircle cx='50' cy='50' r='40' stroke='white' stroke-width='2' fill='none' /%3E%3C/svg%3E");
    background-size: cover;
  }
  .about-hero{margin-top:-60px;padding:20px;display:flex;gap:16px;align-items:center}
  .about-hero .avatar{width:120px;height:120px;border-radius:50%;background:#fff;display:grid;place-items:center;color:#111;font-size:40px; border: 4px solid var(--panel); box-shadow: var(--card-shadow);}
  .about-bio{margin-top:20px;padding:24px;border-radius:16px;background:var(--panel);border:1px solid var(--divider);box-shadow:var(--card-shadow);color:var(--text)}
  .about-bio p {margin-bottom: 16px;}
  .about-name {font-family: 'Poppins', sans-serif; font-weight: 800; font-size: 1.4rem;}
  .about-tagline {color:var(--muted);font-size:14px; margin-bottom: 8px;}

  /* footer & toasts */
  footer{margin-top:32px;padding:24px;text-align:center;color:var(--muted);font-size:14px; border-top: 1px solid var(--divider);}
  .toast-wrap{position:fixed;right:16px;bottom:16px;z-index:600;display:flex;flex-direction:column;gap:10px}
  .toast{padding:12px 16px;border-radius:10px;background:rgba(0,0,0,0.8);color:#fff; backdrop-filter: blur(10px);}

  /* reveal */
  .reveal{opacity:0;transform:translateY(8px);transition:opacity .45s ease, transform .45s ease}
  .reveal.in{opacity:1;transform:none}

  /* social buttons */
  .social-buttons {display: flex; gap: 12px; margin-top: 20px;}
  .social-btn {display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; border-radius: 999px; text-decoration: none; font-weight: 600; transition: all 0.2s ease;}
  .social-btn.youtube {background: var(--youtube-red); color: white;}
  .social-btn.instagram {background: transparent; border: 1px solid var(--divider); color: var(--text);}
  .social-btn:hover {transform: translateY(-2px); opacity: 0.9;}

  /* responsive */
  @media(min-width:980px){
    .wrap{padding:24px}
    .hero-title{font-size:26px}
    .post-title{font-size:20px}
  }
  @media(max-width: 768px) {
    .comp-title {flex-direction: column;}
    .about-hero {flex-direction: column; text-align: center;}
    .social-buttons {justify-content: center;}
  }
</style>
</head>
<body>

<div class="wrap">

  <!-- HEADER -->
  <header>
    <div class="brand">
      <div class="ch-avatar" aria-hidden="true">GZ</div>
      <div>
        <div class="site-title">GenZ Smart</div>
        <div class="site-subtitle">Community • Ideas • Motivation</div>
      </div>
    </div>

    <div class="header-actions">
      <button id="themeToggle" class="icon-btn" title="Toggle theme">🌓</button>
      <button id="menuBtn" class="icon-btn" title="Menu">☰</button>
    </div>
  </header>

  <!-- NAV / TABS -->
  <div class="tabs" role="tablist" aria-label="Views">
    <button class="tab active" data-view="home">Home</button>
    <button class="tab" data-view="blog">Blog <span id="badgeCount" style="margin-left:8px;font-weight:700;color:var(--muted)">0</span></button>
    <button class="tab" data-view="about">About</button>
  </div>

  <!-- HERO -->
  <section class="hero reveal">
    <div class="hero-card">
      <div class="hero-title">GenZ Smart — Community</div>
      <div id="heroQuote" class="hero-quote">"Small ideas, big ripples."</div>
    </div>
  </section>

  <!-- COMPOSER (admin only) -->
  <section id="composer" class="composer reveal" aria-hidden="true" style="display:none">
    <div class="comp-row">
      <div class="comp-avatar">GZ</div>
      <div class="comp-box">
        <div class="comp-title">
          <input id="composeTitle" class="small-input" placeholder="Title (optional)" />
          <input id="composeImage" class="small-input" placeholder="Image URL (optional)" />
        </div>
        <textarea id="composeText" class="comp-text" placeholder="Share something with your community..."></textarea>
        <div class="comp-meta">
          <div style="color:var(--muted);font-size:13px">Publishing as <strong>GenZ Owais</strong></div>
          <div style="display:flex;gap:8px">
            <button id="cancelCompose" class="btn-ghost">Cancel</button>
            <button id="publishBtn" class="btn-red">Publish</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <main>

    <!-- HOME View (7 days) -->
    <section id="homeView" class="view reveal" aria-label="Home view">
      <div style="display:flex;justify-content:space-between;align-items:end; margin-bottom: 16px;">
        <div>
          <h3 style="margin:0">Home</h3>
          <div style="color:var(--muted);font-size:13px">Only posts from the last 7 days appear here.</div>
        </div>
        <div>
          <button id="refreshBtn" class="icon-btn" title="Refresh">⟳</button>
        </div>
      </div>

      <div id="homeFeed" style="display:flex;flex-direction:column;gap:16px"></div>
    </section>

    <!-- BLOG View (all posts) -->
    <section id="blogView" class="view reveal" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:end; margin-bottom: 16px;">
        <div>
          <h3 style="margin:0">Blog</h3>
          <div style="color:var(--muted);font-size:13px">All posts stored forever.</div>
        </div>
        <div>
          <button id="backHome" class="icon-btn" title="Back">←</button>
        </div>
      </div>

      <div id="allFeed" style="display:flex;flex-direction:column;gap:16px"></div>
    </section>

    <!-- SINGLE POST VIEW -->
    <article id="postView" class="post-view reveal" style="display:none">
      <button id="postBack" class="icon-btn" style="margin-bottom:16px">⬅ Back</button>
      <div class="post-card">
        <div class="post-head">
          <div class="post-avatar" id="postAvatar">GZ</div>
          <div class="post-meta">
            <div class="post-author" id="postAuthor">GenZ Smart</div>
            <div class="post-time" id="postTime">Date</div>
          </div>
        </div>
        <div id="postTitle" class="post-title" style="margin-top:16px;"></div>
        <div id="postBody" class="post-body"></div>
        <img id="postImg" class="post-image" style="display:none" alt="post image"/>
        <div id="postAdminActions" style="margin-top:16px"></div>
      </div>
    </article>

    <!-- ABOUT -->
    <section id="aboutView" class="view reveal" style="display:none">
      <div class="about-banner"></div>
      <div class="about-hero">
        <div class="avatar">GZ</div>
        <div>
          <div class="about-name">Owais Ahmad</div>
          <div class="about-tagline">Ideas • Notes • Motivation</div>
        </div>
      </div>
      <div class="about-bio">
        <h3 style="margin-bottom: 16px;">About Me</h3>
        <p>Hey there! I'm Owais Ahmad, a high school student born and raised in the breathtaking valleys of Kashmir, India. I'm passionate about learning new things, exploring creative ideas, and making each day count.</p>
        <p>I've got a curious mind, a drive to grow, and a dream to create something meaningful in this world. Whether it's diving into books, exploring tech, or just enjoying the peace of the mountains—I'm always looking for inspiration.</p>
        <p>I believe in staying positive, working hard, and never stopping the hustle. Still young, but dreaming big and I'm just getting started. Let's make it happen!</p>
        
        <div class="social-buttons">
          <a href="https://youtube.com/@calizenowais?si=y5c2lp6JfCjSiJXB" target="_blank" class="social-btn youtube">
            <span>YouTube</span>
          </a>
          <a href="https://www.instagram.com/owaisdar_511?igsh=MWV6d21lbjVpNXh6Yg==" target="_blank" class="social-btn instagram">
            <span>Instagram</span>
          </a>
        </div>
      </div>
    </section>

  </main>

  <footer>
    © 2025 GenZ Smart Blog — All rights reserved
  </footer>
</div>

<!-- drawer (menu) — opens only when menu clicked -->
<div id="drawerBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:500"></div>
<nav id="drawer" style="position:fixed;left:-100%;top:0;height:100%;width:80vw;max-width:360px;background:var(--panel);padding:24px;border-right:1px solid var(--divider);box-shadow:0 12px 36px rgba(2,6,23,0.12);z-index:510;transition:left .28s cubic-bezier(.2,.9,.2,1)">
  <button id="closeDrawer" style="background:transparent;border:0;color:var(--text);font-size:20px">✕</button>
  <div style="margin-top:20px">
    <div style="font-weight:800;font-family:Poppins; font-size: 1.2rem;">GenZ Smart</div>
    <div style="margin-top:16px"><a href="#" data-view="home" style="text-decoration:none;color:var(--text);font-weight:600; display: block; padding: 10px 0;">🏠 Home</a></div>
    <div style="margin-top:8px"><a href="#" data-view="blog" style="text-decoration:none;color:var(--text);font-weight:600; display: block; padding: 10px 0;">📰 Blog</a></div>
    <div style="margin-top:8px"><a href="#" data-view="about" style="text-decoration:none;color:var(--text);font-weight:600; display: block; padding: 10px 0;">👤 About</a></div>
    <div style="height:1px;background:var(--divider);margin:16px 0"></div>
    <button id="openLogin" style="background:var(--youtube-red);color:#fff;padding:10px 16px;border-radius:8px;border:0;font-weight:600;cursor:pointer; width: 100%;">🔐 Admin Login</button>
  </div>
</nav>

<!-- toast area -->
<div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

<!-- FIREBASE & APP LOGIC -->
<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
  onSnapshot, query, orderBy, serverTimestamp, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBZTAhJne3gOVwBrZ_NHQFo0ubWR8HzNL8",
  authDomain: "sample-firebase-ai-app-d0a89.firebaseapp.com",
  projectId: "sample-firebase-ai-app-d0a89",
  storageBucket: "sample-firebase-ai-app-d0a89.firebasestorage.app",
  messagingSenderId: "537274583564",
  appId: "1:537274583564:web:44ea454c2abed7d9a4bc29"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* helpers */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const el = id => document.getElementById(id);

// Removed the line that was causing the error: el('year').textContent = new Date().getFullYear();

function toast(msg, type='ok'){
  const wrap = el('toastWrap');
  const d = document.createElement('div'); d.className='toast';
  if(type === 'ok') d.textContent = '✨ ' + msg;
  else if(type === 'edit') d.textContent = '✏️ ' + msg;
  else if(type === 'del') d.textContent = '🗑️ ' + msg;
  else if(type === 'err'){ d.textContent = msg; d.style.background = 'linear-gradient(90deg,#ef4444,#ff7b7b)'; }
  else d.textContent = msg;
  wrap.appendChild(d); setTimeout(()=> d.remove(), 3200);
}

/* elements */
const menuBtn = qs('#menuBtn'), drawer = qs('#drawer'), drawerBackdrop = qs('#drawerBackdrop'), closeDrawer = qs('#closeDrawer'), openLogin = qs('#openLogin');
const tabs = qsa('.tab');
const composer = qs('#composer'), composeText = qs('#composeText'), composeTitle = qs('#composeTitle'), composeImage = qs('#composeImage');
const publishBtn = qs('#publishBtn');
const cancelCompose = qs('#cancelCompose'), refreshBtn = qs('#refreshBtn'), backHome = qs('#backHome');
const homeFeed = qs('#homeFeed'), allFeed = qs('#allFeed');
const postView = qs('#postView'), postTitle = qs('#postTitle'), postBody = qs('#postBody'), postAvatar = qs('#postAvatar'), postAuthor = qs('#postAuthor'), postTime = qs('#postTime'), postImg = qs('#postImg'), postAdminActions = qs('#postAdminActions');
const postBack = qs('#postBack');
const themeToggle = qs('#themeToggle');
const badgeCount = qs('#badgeCount');

/* state */
let isAdmin = false;
let currentView = 'home';
let lastViewBeforePost = 'home';

/* admin credentials */
const ADMIN_EMAIL = 'saffanakbar942@gmail.com';
const ADMIN_PASS  = 'saffan942';

/* theme handling default = light (YouTube style) */
if(localStorage.siteTheme === undefined) localStorage.siteTheme = 'light';
applyTheme(localStorage.siteTheme);
themeToggle?.addEventListener('click', ()=> applyTheme(localStorage.siteTheme === 'light' ? 'dark' : 'light'));
function applyTheme(t){ if(t === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); localStorage.siteTheme = t; }

/* drawer open/close */
menuBtn?.addEventListener('click', ()=> { drawer.style.left = '0'; drawerBackdrop.style.display = 'block'; });
closeDrawer?.addEventListener('click', ()=> { drawer.style.left = '-100%'; drawerBackdrop.style.display = 'none'; });
drawerBackdrop?.addEventListener('click', ()=> { drawer.style.left = '-100%'; drawerBackdrop.style.display = 'none'; });

/* tabs navigation */
tabs.forEach(t => {
  t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const view = t.getAttribute('data-view');
    showView(view);
    drawer.style.left = '-100%'; drawerBackdrop.style.display = 'none';
  });
});

function hideAllViews(){ 
  qs('#homeView').style.display='none'; 
  qs('#blogView').style.display='none'; 
  qs('#aboutView').style.display='none'; 
  qs('#postView').style.display='none'; 
}
function showView(v){
  hideAllViews();
  if(v === 'home'){ qs('#homeView').style.display='block'; currentView='home'; document.title='GenZ Smart — Home'; }
  if(v === 'blog'){ qs('#blogView').style.display='block'; currentView='blog'; document.title='GenZ Smart — Blog'; }
  if(v === 'about'){ qs('#aboutView').style.display='block'; currentView='about'; document.title='GenZ Smart — About'; }
  window.scrollTo({top:0,behavior:'smooth'});
}

/* login modal (only appears when clicking menu) */
const loginModal = (() => {
  const wrap = document.createElement('div');
  wrap.style.cssText = 'position:fixed;inset:0;display:none;place-items:center;z-index:700;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.35))';
  wrap.id = 'loginModal';
  const card = document.createElement('div');
  card.style.cssText = 'width:92%;max-width:420px;background:var(--panel);padding:24px;border-radius:16px;border:1px solid var(--divider);box-shadow:var(--card-shadow)';
  card.innerHTML = `<h3 style="margin:0 0 12px;font-family:Poppins">🔐 Admin Login</h3>
    <p style="margin:0 0 16px;color:var(--muted)">Sign in to publish and manage posts.</p>
    <div style="display:flex;flex-direction:column;gap:12px">
      <input id="lmEmail" class="small-input" placeholder="Admin email" />
      <input id="lmPass" class="small-input" placeholder="Password" type="password" />
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:12px">
        <button id="lmCancel" class="btn-ghost">Cancel</button>
        <button id="lmSubmit" class="btn-red">Sign in</button>
      </div>
    </div>`;
  wrap.appendChild(card); document.body.appendChild(wrap);
  return wrap;
})();

openLogin?.addEventListener('click', ()=> {
  drawer.style.left = '-100%'; drawerBackdrop.style.display = 'none';
  loginModal.style.display = 'grid';
  const lmEmail = el('lmEmail'), lmPass = el('lmPass'), lmCancel = el('lmCancel'), lmSubmit = el('lmSubmit');
  lmEmail.value = ''; lmPass.value = '';
  lmCancel.onclick = ()=> loginModal.style.display = 'none';
  lmSubmit.onclick = ()=> {
    const em = lmEmail.value?.trim(), pw = lmPass.value?.trim();
    if(!em || !pw){ toast('Enter email & password','err'); return; }
    if(em !== ADMIN_EMAIL || pw !== ADMIN_PASS){ toast('Invalid credentials','err'); return; }
    isAdmin = true;
    composer.style.display = 'flex';
    loginModal.style.display = 'none';
    toast('✨ Admin signed in — composer unlocked', 'ok');
    setTimeout(()=> composer.scrollIntoView({behavior:'smooth', block:'center'}), 150);
  };
});

/* helpers for posts display */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function linkifySafe(text){ const esc = escapeHtml(text); return esc.replace(/(https?:\/\/[^\s]+)/g,u=>`<a href="${u}" target="_blank" rel="noopener" style="color:var(--accent)">${u}</a>`); }
function within7Days(ts){ if(!ts) return true; const t = ts.toMillis ? ts.toMillis() : (+ts||Date.now()); return (Date.now()-t) <= 7*24*60*60*1000; }
function clearChildren(node){ while(node.firstChild) node.removeChild(node.firstChild); }

/* posts collection */
const postsCol = collection(db,'posts');

/* create post card (home/blog) */
function createCard(docSnap){
  const data = docSnap.data();
  const when = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();
  const card = document.createElement('div'); card.className = 'post-card reveal';

  // head
  const head = document.createElement('div'); head.className = 'post-head';
  const av = document.createElement('div'); av.className = 'post-avatar';
  if(data.avatar){
    const img = document.createElement('img'); img.src = data.avatar; img.style.width='48px'; img.style.height='48px'; img.style.borderRadius='50%'; img.style.objectFit='cover';
    img.onerror = ()=> av.textContent = 'GZ';
    av.innerHTML = ''; av.appendChild(img);
  } else {
    av.textContent = 'GZ';
  }
  const meta = document.createElement('div'); meta.className = 'post-meta';
  const name = document.createElement('div'); name.className='post-author'; name.textContent = data.author || 'GenZ Smart';
  const time = document.createElement('div'); time.className='post-time'; time.textContent = when.toDateString();
  meta.appendChild(name); meta.appendChild(time);
  head.appendChild(av); head.appendChild(meta);
  card.appendChild(head);

  // title
  if(data.title && data.title.toString().trim() !== ''){
    const t = document.createElement('div'); t.className='post-title'; t.textContent = data.title;
    t.style.cursor = 'pointer';
    t.addEventListener('click', ()=> openSinglePost(docSnap.id, data));
    card.appendChild(t);
  }

  // body with truncation
  const body = document.createElement('div'); body.className = 'post-body';
  const full = data.content || '';
  if(full.length <= 100){
    body.innerHTML = linkifySafe(full);
  } else {
    const short = full.slice(0,100);
    body.innerHTML = linkifySafe(short) + '…';
    const more = document.createElement('span'); more.className='read-more'; more.textContent=' Read more';
    let expanded=false;
    more.addEventListener('click', ()=>{
      expanded = !expanded;
      if(expanded){ body.innerHTML = linkifySafe(full); more.textContent = ' Show less'; body.appendChild(more); }
      else { body.innerHTML = linkifySafe(short) + '…'; more.textContent = ' Read more'; body.appendChild(more); }
    });
    body.appendChild(more);
  }
  card.appendChild(body);

  // image optional
  if(data.image){
    const im = document.createElement('img'); im.className='post-image'; im.src = data.image;
    im.onerror = ()=> im.style.display = 'none';
    card.appendChild(im);
  }

  // admin actions if signed in
  if(isAdmin){
    const actions = document.createElement('div'); actions.className = 'post-actions';
    const edit = document.createElement('button'); edit.className='btn-ghost'; edit.textContent='Edit';
    const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Delete';
    edit.addEventListener('click', async ()=>{
      const d = await getDoc(doc(db,'posts',docSnap.id));
      if(!d.exists()){ toast('Not found','err'); return; }
      const pd = d.data();
      composeTitle.value = pd.title || ''; composeText.value = pd.content || ''; composeImage.value = pd.image || '';
      let existing = el('editId'); if(existing) existing.remove();
      const hid = document.createElement('input'); hid.type='hidden'; hid.id='editId'; hid.value = docSnap.id; document.body.appendChild(hid);
      composer.style.display = 'flex';
      setTimeout(()=> composer.scrollIntoView({behavior:'smooth', block:'center'}),120);
    });
    del.addEventListener('click', async ()=>{
      if(!confirm('Delete this post?')) return;
      try{ await deleteDoc(doc(db,'posts',docSnap.id)); toast('Post deleted','del'); } catch(e){ toast(e.message,'err'); }
    });
    actions.appendChild(edit); actions.appendChild(del);
    card.appendChild(actions);
  }

  return card;
}

/* open single post view */
function openSinglePost(id, data){
  el('postTitle').textContent = data.title || '';
  postBody.innerHTML = linkifySafe(data.content || '');
  postAuthor.textContent = data.author || 'GenZ Smart';
  const when = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();
  postTime.textContent = when.toDateString();

  // image
  if(data.image){
    postImg.src = data.image; postImg.style.display = 'block';
    postImg.onerror = ()=> postImg.style.display = 'none';
  } else postImg.style.display = 'none';

  // avatar
  postAvatar.innerHTML = '';
  if(data.avatar){
    const im = document.createElement('img'); im.src = data.avatar; im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover'; im.style.borderRadius='50%';
    im.onerror = ()=> postAvatar.textContent = 'GZ';
    postAvatar.appendChild(im);
  } else postAvatar.textContent = 'GZ';

  // admin actions
  postAdminActions.innerHTML = '';
  if(isAdmin){
    const edit = document.createElement('button'); edit.className='btn-ghost'; edit.textContent='Edit';
    const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Delete';
    edit.onclick = async ()=> {
      const d = await getDoc(doc(db,'posts',id));
      if(!d.exists()){ toast('Not found','err'); return; }
      const pd = d.data(); composeTitle.value = pd.title || ''; composeText.value = pd.content || ''; composeImage.value = pd.image || '';
      let existing = el('editId'); if(existing) existing.remove();
      const hid = document.createElement('input'); hid.type='hidden'; hid.id='editId'; hid.value = id; document.body.appendChild(hid);
      composer.style.display = 'flex'; setTimeout(()=> composer.scrollIntoView({behavior:'smooth', block:'center'}),120);
    };
    del.onclick = async ()=> {
      if(!confirm('Delete this post?')) return;
      try{ await deleteDoc(doc(db,'posts',id)); toast('Post deleted','del'); showHome(); } catch(e){ toast(e.message,'err'); }
    };
    postAdminActions.appendChild(edit); postAdminActions.appendChild(del);
  }

  // switch view
  document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
  postView.style.display = 'block';
  lastViewBeforePost = currentView || 'home';
  document.title = 'GenZ Smart — ' + (data.title || 'Post');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* back from single */
postBack.addEventListener('click', ()=> {
  if(lastViewBeforePost === 'blog') showView('blog'); else showView('home');
  document.title = 'GenZ Smart — Community';
});

/* realtime listener */
let unsub = null;
function startRealtime(){
  clearChildren(homeFeed); clearChildren(allFeed);
  const loading = document.createElement('div'); loading.className='post-card'; loading.style.textAlign='center'; loading.innerHTML = 'Loading...';
  homeFeed.appendChild(loading); allFeed.appendChild(loading.cloneNode(true));
  if(unsub) unsub();
  const q = query(postsCol, orderBy('timestamp','desc'));
  unsub = onSnapshot(q, snap => {
    clearChildren(homeFeed); clearChildren(allFeed);
    const docs = snap.docs || [];
    const total = docs.length || 0;
    if(badgeCount) badgeCount.textContent = total;
    // all feed
    if(docs.length === 0){
      const e = document.createElement('div'); e.className='post-card'; e.textContent = 'No posts yet.'; allFeed.appendChild(e);
    } else {
      docs.forEach(d => allFeed.appendChild(createCard(d)));
    }
    // home: last 7 days only
    const recent = docs.filter(d => within7Days(d.data().timestamp));
    if(recent.length === 0){
      const e = document.createElement('div'); e.className='post-card'; e.textContent = 'No posts in the last 7 days.'; homeFeed.appendChild(e);
    } else {
      recent.forEach(d => homeFeed.appendChild(createCard(d)));
    }
    // reveal animations
    setTimeout(()=> qsa('.reveal').forEach(x => x.classList.add('in')), 80);
  }, err => {
    clearChildren(homeFeed); clearChildren(allFeed);
    const e = document.createElement('div'); e.className='post-card'; e.textContent = 'Error loading posts: ' + err.message;
    homeFeed.appendChild(e); allFeed.appendChild(e.cloneNode(true));
  });
}

/* publish / edit logic */
publishBtn?.addEventListener('click', async ()=>{
  const content = (composeText.value || '').trim();
  const title = (composeTitle.value || '').trim();
  const image = (composeImage.value || '').trim();
  if(!content){ toast('Write something before publishing','err'); return; }
  try{
    const existing = el('editId');
    if(existing){
      await updateDoc(doc(db,'posts',existing.value), { title, content, image });
      existing.remove();
      toast('Post updated','edit');
    } else {
      await addDoc(postsCol, { title, content, image, author:'GenZ Owais', timestamp: serverTimestamp() });
      toast('New post published successfully', 'ok');
    }
    composeText.value=''; composeTitle.value=''; composeImage.value='';
    composer.style.display = 'none';
  } catch(e){ toast(e.message,'err'); }
});
cancelCompose?.addEventListener('click', ()=> {
  composeText.value=''; composeTitle.value=''; composeImage.value='';
  const existing = el('editId'); if(existing) existing.remove();
  composer.style.display='none';
});

/* refresh button */
refreshBtn?.addEventListener('click', ()=> { startRealtime(); toast('Refreshed','ok'); });

/* reveal observer */
const io = new IntersectionObserver(entries => {
  entries.forEach(en => { if(en.isIntersecting){ en.target.classList.add('in'); io.unobserve(en.target); } });
}, { threshold: .12 });

/* init */
startRealtime();
showView('home');
setTimeout(()=> qsa('.reveal').forEach(r => io.observe(r)), 200);

/* ESC closes login/drawer */
document.addEventListener('keydown', e => {
  if(e.key === 'Escape'){ 
    if(loginModal.style.display === 'grid') loginModal.style.display = 'none'; 
    drawer.style.left='-100%'; 
    drawerBackdrop.style.display='none'; 
  }
});

// Add click handlers for drawer navigation
qsa('#drawer a[data-view]').forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const view = link.getAttribute('data-view');
    tabs.forEach(t => {
      if(t.getAttribute('data-view') === view) {
        t.click();
      }
    });
  });
});

// Make sure the back button works
backHome?.addEventListener('click', () => {
  showView('home');
  tabs.forEach(t => {
    if(t.getAttribute('data-view') === 'home') {
      t.classList.add('active');
    } else {
      t.classList.remove('active');
    }
  });
});
</script>
</body>
</html>
